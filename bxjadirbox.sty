%
% bxjadirbox.sty
%
%% package declaration
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{bxjadirbox}[2013/06/01]

%%
\def\xx@pkgname{bxjadirbox}
\def\xx@error{\PackageError\xx@pkgname}
\def\xx@warn{\PackageWarning\xx@pkgname}
\def\xx@info{\PackageWarning\xx@pkgname}
\providecommand\bxDebug[1]{}
%
\def\xx@err@ivbxc#1{%
  \xx@error{Invalid box command \string#1}\@ehc
}
\def\xx@err@ukdir#1{%
  \xx@error{Unknown direction '#1'}\@ehc
}
\def\xx@err@usdch#1#2{%
  \xx@error{Unsupported direction change (#1->#2)}\@ehc
}

\endlinechar=-1
%---------------------------------------
%% Helper stuffs

%% variables
\newbox\xx@tempbox
\newif\ifCJK@vertical@

%% \xx@letcs\CSa{<nameb>}
\def\xx@letcs#1#2{
  \expandafter\let\expandafter#1\csname #2\endcsname
}

%% \xx@if@primitive\CS
\@onlypreamble\xx@if@primitive
\def\xx@if@primitive#1{
  \edef\xx@tempa{\string#1}
  \edef\xx@tempb{\meaning#1}
  \ifx\xx@tempa\xx@tempb \expandafter\@firstofone
  \else \expandafter\@gobble
  \fi
}

%% \ifxx@in@ptex
\newif\ifxx@in@ptex \xx@in@ptexfalse
\xx@if@primitive\kanjiskip{
  \xx@in@ptextrue
}

%% \ifxx@in@xetex
\newif\ifxx@in@xetex \xx@in@xetexfalse
\xx@if@primitive\XeTeXrevision{
  \xx@in@xetextrue
}

%% \ifxx@in@luatex
\newif\ifxx@in@luatex \xx@in@luatexfalse
\xx@if@primitive\luatexrevision{
  \xx@in@luatextrue
}

%% \xx@do@after@setbox
% Makes a promise that \xx@do be executed after completing
% \setbox that follows.
\def\xx@do@after@setbox{
  \let\xx@do@inject\@empty
  \afterassignment\xx@do@after@setbox@a
}
\def\xx@do@after@setbox@a{
  \aftergroup\xx@do
  \xx@do@inject
}

%% \xx@do@after@setbox@with@injection{<text>}
% Same as \xx@do@after@setbox, except that <text> is
% injected at the head of the box.
\def\xx@do@after@setbox@with@injection#1{
  \def\xx@do@inject{#1}%
  \afterassignment\xx@do@after@setbox@a
}

%% \xx@with@burst\CS
\def\xx@with@burst#1{
  \expandafter#1\romannumeral-`>
}

%% \xx@triv@dispatch{<box-reg>}
\def\xx@triv@dispatch#1{
  {\copy#1}
}

%---------------------------------------
%% Driver Selection

%% driver setting procedures
\@onlypreamble\xx@driver@@plain
\def\xx@driver@@plain{\relax} % no-op
\@onlypreamble\xx@driver@@ptex
\let\xx@driver@@ptex\@empty
\@onlypreamble\xx@driver@@xetex
\let\xx@driver@@xetex\@empty
\@onlypreamble\xx@driver@@cjkvert
\let\xx@driver@@cjkvert\@empty

%% \xx@driver@setup{<driver>,...}{<text>}
\def\xx@driver@setup#1#2{
  \@for\xx@x:=#1\do{
    \expandafter\g@addto@macro\csname xx@driver@@\xx@x\endcsname
     {#2}
  }
}

%% \xx@driver
\let\xx@driver\relax

%%<*> \dirboxinitialize
% Does initialization, with auto-detected driver.
\@onlypreamble\dirboxinitialize
\newcommand*\dirboxinitialize{
  \ifxx@in@ptex
    \def\xx@tempa{ptex}
  \else
    \def\xx@tempa{plain}
    \@ifpackageloaded{fontspec}{
      \def\xx@tempa{xetex}
    }{}
    \@ifpackageloaded{CJKvert}{
      \def\xx@tempa{cjkvert}
    }{}
  \fi
  \dirboxinitializewith\xx@tempa
}

%%<*> \dirboxinitializewith{<driver>}
\@onlypreamble\dirboxinitializewith
\newcommand*\dirboxinitializewith[1]{ 
  \edef\xx@driver{#1}
  \xx@letcs\xx@tempa{xx@driver@@\xx@driver}
  \ifx\xx@tempa\relax
    \xx@error{Unknown driver '\xx@driver' specified}
     {Driver 'plain' is used instead.}
    \def\xx@driver{plain}
    \xx@driver@@plain
  \else
    \xx@tempa
  \fi
  \xx@info{Initialized with driver '\xx@driver'}
  % Avoids multiple initialization.
  \def\dirboxinitializewith#1{
    \xx@warn{Already initialized}
  }
}

%% begin-document hook
\AtBeginDocument{
  % Initialize, if not yet done.
  \ifx\xx@driver\relax
    \dirboxinitialize
  \fi
}

%% Checks the engine if driver is 'ptex'
\ifxx@in@ptex\else
\xx@driver@setup{ptex}{
  \xx@error{The engine does not support driver 'ptex'}
  \@ehc
}
\fi

%% Ascertains that the prerequisite package is loaded.
\xx@driver@setup{cjkvert}{
  \@ifpackageloaded{CJKvert}{}{%else
    \RequirePackage{CJKvert}
  }
}

%---------------------------------------
%% Level-1 Direction-Box Commands
% The commands here are driver-independent.

%% \xx@scan@boxcmd
\@namedef{xx@bc\string\vbox}{\xx@do\vbox}
\@namedef{xx@bc\string\vtop}{\xx@do\vbox}
\@namedef{xx@bc\string\vcenter}{\xx@do\vbox}
\@namedef{xx@bc\string\hbox}{\xx@do\hbox}
\@namedef{xx@bc\string\setbox}{\xx@handle@setbox}
\@namedef{xx@bc\string\global}{\xx@handle@global}
\def\xx@scan@boxcmd{
  \xx@with@burst\xx@scan@boxcmd@a
}
  % #1 is either \BOXCMD, \setbox or \global
\def\xx@scan@boxcmd@a#1{
  \@nameuse{xx@bc\meaning#1}\xx@boxcmd@error#1%
  % if #1 is unexpected thing, then \@nameuse results in
  % \relax and \xx@boxcmd@error is invoked.
}

%% \xx@handle@global...
  % Checks if '\setbox' really follows
\def\xx@handle@global#1#2\setbox{ 
  \xx@handle@setbox@a\global\setbox
}

%% \xx@handle@setbox...
\def\xx@handle@setbox#1#2{
  \xx@handle@setbox@a\setbox
}
  % Called as \xx@handle@setbox@a[\global]\setbox...=\BOXCMD
  % #3 is picked up so as to gobble spaces.
\def\xx@handle@setbox@a#1#2=#3{
  \def\xx@do@assign{#1#2=}
  \ifx#1\setbox% is local assignment
    \def\xx@do@refer{#2}% used in \xx@takeout@box
  \fi
  % Back to the beginning
  \xx@scan@boxcmd#3
}

%% \xx@boxcmd@error\CS
\def\xx@boxcmd@error#1{
  \xx@err@ivbxc#1
  \vbox
}

%%<+> \UseDirBoxRotRInYoko{<box-reg>}
\newcommand*\UseDirBoxRotRInYoko[1]{
  \vbox{
    \hbox{\rotatebox{-90}{\copy#1}}
    \kern\z@
  }%
}

%%<+> \UseDirBoxRotLInYoko{<box-reg>}
\newcommand*\UseDirBoxRotLInYoko[1]{
  \vbox{
    \hbox{\rotatebox{90}{\copy#1}}
    \kern\z@
  }%
}

%%<+> \UseDirBoxYokoInRotR{<box-reg>}
\newcommand*\UseDirBoxYokoInRotR[1]{
  \vbox{
    \hbox{\rotatebox{90}{\copy#1}}
    \kern-.5\wd#1\relax
    \hrule\@width\z@\@height\z@\@depth.5\wd#1\relax
  }%
}

%%<+> \RawDirBoxRotRInYoko[[\global]\setbox<box-reg>=]
%       \BOXCMD<box-spec>{<text>}
% (where \BOXCMD is one of \vbox / \vtop / \vcenter / \hbox
\newcommand\RawDirBoxRotRInYoko{
  \let\xx@do@usebox\UseDirBoxRotRInYoko
  \xx@rdirbox@gen
}

%%<+> \RawDirBoxRotLInYoko[[\global]\setbox<box-reg>=]
%       \BOXCMD<box-spec>{<text>}
% (where \BOXCMD is one of \vbox / \vtop / \vcenter / \hbox
\newcommand\RawDirBoxRotLInYoko{
  \let\xx@do@usebox\UseDirBoxRotLInYoko
  \xx@rdirbox@gen
}

%%<+> \RawDirBoxYokoInRotR[[\global]\setbox<box-reg>=]
%       \BOXCMD<box-spec>{<text>}
% (where \BOXCMD is one of \vbox / \vtop / \vcenter / \hbox
\newcommand\RawDirBoxYokoInRotR{
  \let\xx@do@usebox\UseDirBoxYokoInRotR
  \xx@rdirbox@gen
}

%% \xx@rdirbox@gen...
\def\xx@rdirbox@gen{
  \xx@preproc@dispatcher
  \let\xx@do\xx@rdirbox@gen@b
  \let\xx@do@refer\relax
  \let\xx@do@assign\@empty
  \xx@scan@boxcmd
}
  % #2(= \xx@boxcmd@error) is discarded.
\def\xx@rdirbox@gen@b#1#2#3{
  \let\xx@do@boxcmd#3% = \BOXCMD
  \let\xx@do\xx@rdirbox@gen@c
  \xx@do@after@setbox
  \setbox\xx@tempbox=#1% 'inner' box command
}
  % Invoked after \setbox is done.
\def\xx@rdirbox@gen@c{
  \ifx\xx@def@dispatcher\relax
    \xx@do@assign% '\setbox...=' or empty
    \xx@do@boxcmd{\xx@do@usebox\xx@tempbox}
  \else
    \xx@do@assign\box\xx@tempbox
    \xx@def@dispatcher\xx@do@usebox
  \fi
  \xx@rdirbox@postproc
  \let\xx@rdirbox@postproc\relax
}

%% \xx@rdirbox@postproc
\let\xx@rdirbox@postproc\@empty

%% \xx@preproc@dispatcher
\def\xx@preproc@dispatcher{
  \expandafter\xx@preproc@dispatcher@a\xx@dispatcher\relax\@nil
}
\def\xx@preproc@dispatcher@a#1#2\@nil{
  \ifx#1\relax
    \let\xx@def@dispatcher\relax
  \else
    % \xx@dispatch must not be propagated to inner boxes.
    \let\xx@dispatcher\relax
    \def\xx@def@dispatcher{\global\let#1}
  \fi
}

%% \xx@takeout@box
\newbox\xx@g@takeout
\def\xx@takeout@box{
  \global\setbox\xx@g@takeout=\box\xx@do@refer
  \xdef\xx@takeout@code{
    \setbox\xx@do@refer=\box\xx@g@takeout
  }
  \aftergroup\xx@takeout@code
}

%---------------------------------------
%% Level-1 ptex wrapper
\ifxx@in@ptex                   %<*pTeX>

%%<+> \InjectDirCmd\DIRCMD
\newcommand*\InjectDirCmd[1]{
  \xx@inject@preproc@dispatcher
  \def\xx@args{{#1}}
  \let\xx@do\xx@inject@dircmd@a
  \let\xx@do@refer\relax
  \let\xx@do@assign\@empty
  \xx@scan@boxcmd
}
\def\xx@inject@dircmd@a#1#2#3{
  \ifx\xx@args\xx@args@ROTR
    \xx@inject@rotr#3
  \fi
  \let\xx@do@boxcmd#3% = \BOXCMD
  \let\xx@do\xx@inject@dircmd@b
  \ifx#3\vcenter
    \def\xx@rhs@assign{\vcenter{\box\xx@tempbox}}
    \def\xx@tempa{\vbox}
  \else
    \def\xx@rhs@assign{\box\xx@tempbox}
    \def\xx@tempa{#3}
  \fi
  \expandafter\xx@do@after@setbox@with@injection\xx@args
  \setbox\xx@tempbox=\xx@tempa
}
  % Invoked after \setbox is done.
\def\xx@inject@dircmd@b{
  \xx@do@assign\xx@rhs@assign
  \xx@rdirbox@postproc
  \let\xx@rdirbox@postproc\relax
}

%%<+> \ROTR
\newcommand*{\ROTR}{\noexpand\xx@ROTR}

%% \xx@args@ROTR
\def\xx@args@ROTR{{\ROTR}}

%% \xx@inject@rotr\BOXCMD
\def\xx@inject@rotr#1{
  \ifx#1\hbox
    \def\xx@args{{\tate
     $#1\bgroup\aftergroup\xx@inject@rotr@a}}
  \else
    \def\xx@args{{\tate
     \hbox\bgroup$#1\bgroup\aftergroup\xx@inject@rotr@b}}
  \fi
}
\def\xx@inject@rotr@a{
  \m@th$\egroup
}
\def\xx@inject@rotr@b{
  \m@th$\egroup\egroup
}

%% \xx@inject@preproc@dispatcher
\def\xx@inject@preproc@dispatcher{
  \expandafter\xx@inject@preproc@dispatcher@a
   \xx@dispatcher\relax\@nil
}
\def\xx@inject@preproc@dispatcher@a#1#2\@nil{
  \ifx#1\relax\else
    \let\xx@dispatcher\relax
    \global\let#1\xx@triv@dispatch
  \fi
}

\fi                             %</pTeX>
%---------------------------------------
%% Font Switching

%%<+> \SwitchFontToYoko
\newcommand*\SwitchFontToYoko{
}

%%<+> \SwitchFontToTate
\newcommand*\SwitchFontToTate{
}

\xx@driver@setup{xetex}{%       %<*xetex>
%% Patch to \defaultfontfeatures

}                               %</xetex>
\xx@driver@setup{cjkvert}{%     %<*cjkvert>
\renewcommand*\SwitchFontToYoko{
  \ifCJK@vertical@
    \CJKhorz
    \aftergroup\CJKvert
  \fi
}
\renewcommand*\SwitchFontToTate{
  \ifCJK@vertical@\else
    \CJKvert
    \aftergroup\CJKhorz
  \fi
}

\newcommand*\setlogicalpagedir[1]{
  \xx@letcs\xx@init@cjkdir{xx@cjkdir@@#1}
  \ifx\xx@init@cjkdir\relax
    \xx@err@ukdir#1
  \else
    \SetCurrentBoxDir{#1}
  \fi
}
\def\xx@cjkdir@@y{\CJKhorz}
\def\xx@cjkdir@@t{\CJKvert}
\let\xx@init@cjkdir\CJKhorz
\AtBeginDocument{
  \xx@init@cjkdir
}
}                               %</cjkvert>

%---------------------------------------
%% Handling Direction Information

%% \xx@curr@dir
\def\xx@dir@dyna{*}
\def\xx@dir@inv{?}
\let\xx@dir@@y\xx@dir@dyna
\def\xx@dir@@z{z}
\def\xx@dir@@d{d}
\let\xx@curr@dir\xx@dir@dyna

%%<+> \SetCurrentBoxDir{<dir>}
\newcommand*\SetCurrentBoxDir[1]{
  \xx@letcs\xx@curr@dir{xx@dir@@#1}
  \ifx\xx@curr@dir\relax
    \xx@err@ukdir#1
    \let\xx@curr@dir\xx@dir@inv
  \fi
}

%%<+> \CurrentBoxDir
\newcommand*\CurrentBoxDir{
  \if\xx@curr@dir\xx@dir@dyna y
  \else \xx@curr@dir
  \fi
}

\xx@driver@setup{xetex,cjkvert}{%<*xetex|cjkvert>
%% more directions supported
\def\xx@dir@@t{t}
}                               %</xetex|cjkvert>

\ifxx@in@ptex
\begingroup
  \catcode`|=0 %
\xx@driver@setup{ptex}{%        %<*ptex>
%% more directions supported
% Declares y, t, d to be dynamic.
\let\xx@dir@@y\xx@dir@dyna
\let\xx@dir@@t\xx@dir@dyna
\let\xx@dir@@d\xx@dir@dyna

%%<+> \CurrentBoxDir
\renewcommand*\CurrentBoxDir{
  \if\xx@curr@dir\xx@dir@dyna
    % 'dynamic' directions
    |ifydir y
    |else|iftdir t
    |else|ifddir d
    |else \xx@dir@inv
    |fi|fi|fi
  \else \xx@curr@dir
  \fi
}

}                               %</ptex>
\endgroup
\fi

%---------------------------------------
%% Level-2 Direction-Box Commands

%%<*> \DirBox{<dir>}...
\newcommand*\DirBox[1]{
  \let\xx@dispatcher\relax
  \xx@letcs\xx@dirbox@dirhndl{xx@dirh@@\CurrentBoxDir @#1}
  \ifx\xx@dirbox@dirhndl\relax
    \xx@err@usdch\CurrentBoxDir#1
  \fi
  \xx@dirbox@dirhndl
}

%% \xx@dispatcher
\let\xx@dispatcher\relax

%%<+> \PrepareDIrBox{<dir>}\CS{<box-reg>}=\BOXCMD{<text>}
\newcommand*\PrepareDirBox[2]{
  \def\xx@dispatcher{#2}
  \xx@letcs\xx@dirbox@dirhndl{xx@dirh@@\CurrentBoxDir @#1}
  \ifx\xx@dirbox@dirhndl\relax
    \xx@err@usdch\CurrentBoxDir#1
    \let#2\xx@triv@dispatch
  \fi
  \xx@dirbox@dirhndl\setbox
}
%% Trivial direction handlers.
\let\xx@dirh@@y@y\@empty
\let\xx@dirh@@t@t\@empty
\let\xx@dirh@@z@z\@empty
\let\xx@dirh@@d@d\@empty

%% \xx@local@dirbox
\def\xx@local@dirbox{
  \begingroup
    \let\xx@rdirbox@postproc\xx@local@dirbox@a
}
\def\xx@local@dirbox@a{
    \xx@takeout@box
  \endgroup
}

%% \xx@dirh@@y@z
\def\xx@dirh@@y@z{
  \xx@local@dirbox
  \SetCurrentBoxDir{z}
  \RawDirBoxRotRInYoko
}

%% \xx@dirh@@y@d
\def\xx@dirh@@y@d{
  \xx@local@dirbox
  \SetCurrentBoxDir{d}
  \RawDirBoxRotLInYoko
}

%% \xx@dirh@@z@y
\def\xx@dirh@@z@y{
  \xx@local@dirbox
  \SetCurrentBoxDir{y}
  \RawDirBoxYokoInRotR
}

\xx@driver@setup{xetex,cjkvert}{%<*xetex|cjkvert>

%% \xx@dirh@@y@t
\def\xx@dirh@@y@t{
  \xx@local@dirbox
  \SetCurrentBoxDir{t}
  \SwitchFontToTate
  \RawDirBoxRotRInYoko
}

%% \xx@dirh@@t@y
\def\xx@dirh@@t@y{
  \xx@local@dirbox
  \SetCurrentBoxDir{y}
  \SwitchFontToYoko
  \RawDirBoxYokoInRotR
}

}                               %</xetex|cjkvert>

\xx@driver@setup{ptex}{%        %<*ptex>

%% \xx@dirh@@@@y
\def\xx@dirh@@@@y{
  \xx@local@dirbox
  \SetCurrentBoxDir{y}
  \InjectDirCmd\yoko
}
%% \xx@dirh@@@@z
\def\xx@dirh@@@@z{
  \xx@local@dirbox
  \SetCurrentBoxDir{z}
  \InjectDirCmd\ROTR
}
%% \xx@dirh@@@@t
\def\xx@dirh@@@@t{
  \xx@local@dirbox
  \SetCurrentBoxDir{t}
  \InjectDirCmd\tate
}
%% \xx@dirh@@@@d
\def\xx@dirh@@@@d{
  \xx@local@dirbox
  \SetCurrentBoxDir{d}
  \InjectDirCmd\dtou
}

%% \xx@dirh@@y@t
\let\xx@dirh@@y@z\xx@dirh@@@@z
\let\xx@dirh@@y@t\xx@dirh@@@@t
\let\xx@dirh@@y@d\xx@dirh@@@@d
\let\xx@dirh@@z@y\xx@dirh@@@@y
\let\xx@dirh@@t@y\xx@dirh@@@@y

}                               %</ptex>

%---------------------------------------

%% \xx@dirparbox@opt\CS
% Reads optional arguments  (dir, pos, height, valign)and
% goes to \CS.
\def\xx@dirparbox@opt#1{
  \let\xx@next=#1
  \@ifnextchar<
   {\xx@dirparbox@opt@a}
   {\xx@dirparbox@opt@b}
}
\def\xx@dirparbox@opt@a<#1>{
  \xx@dirparbox@opt@b{#1}
}
\def\xx@dirparbox@opt@b#1{
  \edef\xx@opt@dir{#1}
  \@testopt\xx@dirparbox@opt@c{c}
}
\def\xx@dirparbox@opt@c[#1]{
  \edef\xx@opt@pos{#1}
  \@testopt\xx@dirparbox@opt@d{}
}
\def\xx@dirparbox@opt@d[#1]{
  \edef\xx@opt@height{#1}
  \@testopt\xx@dirparbox@opt@e{s}
}
\def\xx@dirparbox@opt@e[#1]{
  \edef\xx@opt@valign{#1}
  \xx@next
}

%% \xx@make@box@vars
\def\xx@make@box@vars{
  \def\width{\wd\@tempboxa}
  \def\height{\ht\@tempboxa}
  \def\depth{\dp\@tempboxa}
  \let\totalheight\@ovri
  \totalheight\height
  \advance\totalheight\depth
}

\def\xx@dirparbox@setparam{
  \edef\xx@curr@dir{\CurrentBoxDir}
  \ifx\xx@opt@dir\@empty
    \let\xx@opt@dir\xx@curr@dir
  \fi
  \ifx\xx@opt@dir\xx@curr@dir
    \@nameuse{xx@dpbi@@\xx@opt@pos}
  \else
    \xx@letcs\xx@tempa
     {xx@dpb@@\xx@curr@dir @\xx@opt@dir @\xx@opt@pos}
    \ifx\xx@tempa\relax
      \xx@err@ivdpb\xx@curr@dir\xx@opt@dir\xx@opt@pos
      \@nameuse{xx@dpbi@@\xx@opt@pos}
    \else \xx@tempa
    \fi
  \fi
}

%%<*> \dirparbox
\newcommand*\dirparbox{
  \xx@dirparbox@opt\xx@dir@parbox@a
}
\def\xx@dirparbox@a#1#2{%<width><text>
  \leavevmode
  \begingroup
    \xx@dirparbox@setparam
    \xx@dirbox@gen\xx@opt@dir\setbox\@tempboxa=\vbox{
      \hsize=\@tempdima
      \@parboxrestore
      \xx@adjustbaselines
      #2\@@par
    }
    %
    \ifx\xx@opt@height\@empty\else
      \setlength\@tempdimb{\xx@opt@height}
      \def\@parboxto{to\@tempdimb}
    \fi
     
}

%---------------------------------------
% All done
\endlinechar=13
\endinput
%% EOF
