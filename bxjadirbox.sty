%
% bxjadirbox.sty
%
%% package declaration
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{bxjadirbox}[2013/06/01]

%%
\def\xx@pkgname{bxjadirbox}
\def\xx@error{\PackageError\xx@pkgname}
\def\xx@warn{\PackageWarning\xx@pkgname}
\def\xx@info{\PackageWarning\xx@pkgname}
\providecommand\bxDebug[1]{}
%
\def\xx@err@ivbxc#1{%
  \xx@error{Invalid box command \string#1}\@ehc
}
\def\xx@err@ukdir#1{%
  \xx@error{Unknown direction '#1'}\@ehc
}
\def\xx@err@usdch#1#2{%
  \xx@error{Unsupported direction change (#1->#2)}\@ehc
}

\endlinechar=-1
%---------------------------------------
%% Helper stuffs

%% variables
\newbox\xx@tempbox
\newif\ifCJK@vertical@

%% \xx@if@primitive\CS
\@onlypreamble\xx@if@primitive
\def\xx@if@primitive#1{
  \edef\xx@tempa{\string#1}
  \edef\xx@tempb{\meaning#1}
  \ifx\xx@tempa\xx@tempb \expandafter\@firstofone
  \else \expandafter\@gobble
  \fi
}

%% \ifxx@in@ptex
\newif\ifxx@in@ptex \xx@in@ptexfalse
\xx@if@primitive\kanjiskip{
  \xx@in@ptextrue
}

%% \ifxx@in@Xetex
\newif\ifxx@in@xetex \xx@in@xetexfalse
\xx@if@primitive\XeTeXrevision{
  \xx@in@xetextrue
}

%% \ifxx@in@luatex
\newif\ifxx@in@luatex \xx@in@luatexfalse
\xx@if@primitive\luatexrevision{
  \xx@in@luatextrue
}

%% \xx@do@after@setbox
% Makes a promise that \xx@do be executed after completing
% \setbox that follows.
\def\xx@do@after@setbox{
  \afterassignment\xx@do@after@setbox@a
}
\def\xx@do@after@setbox@a{
  \aftergroup\xx@do
}

%% \xx@with@burst\CS
\def\xx@with@burst#1{
  \expandafter#1\romannumeral-`>
}

%---------------------------------------
%% Driver Selection

%% driver setting procedures
\@onlypreamble\xx@driver@@plain
\def\xx@driver@@plain{\relax} % no-op
\@onlypreamble\xx@driver@@ptex
\let\xx@driver@@ptex\@empty
\@onlypreamble\xx@driver@@xetex
\let\xx@driver@@xetex\@empty
\@onlypreamble\xx@driver@@cjkvert
\let\xx@driver@@cjkvert\@empty

%% \xx@driver@setup{<driver>,...}{<text>}
\def\xx@driver@setup#1#2{
  \@for\xx@x:=#1\do{
    \expandafter\g@addto@macro\csname xx@driver@@\xx@x\endcsname
     {#2}
  }
}

%% \xx@driver
\let\xx@driver\relax

%%<*> \dirboxinitialize
\@onlypreamble\dirboxinitialize
\newcommand*\dirboxinitialize{
  \ifxx@in@ptex
    \def\xx@tempa{ptex}
  \else
    \def\xx@tempa{plain}
    \@ifpackageloaded{fontspec}{
      \def\xx@tempa{xetex}
    }{}
    \@ifpackageloaded{CJKvert}{
      \def\xx@tempa{cjkvert}
    }{}
  \fi
  \dirboxinitializewith\xx@tempa
}

%%<*> \dirboxinitializewith
\@onlypreamble\dirboxinitializewith
\newcommand*\dirboxinitializewith[1]{ 
  \edef\xx@driver{#1}
  \expandafter\let\expandafter\xx@tempa
   \csname xx@driver@@\xx@driver\endcsname
  \ifx\xx@tempa\relax
    \xx@error{Unknown driver '\xx@driver' specified}
     {Driver 'plain' is used instead.}
    \def\xx@driver{plain}
    \xx@driver@@plain
  \else
    \xx@tempa
  \fi
  \xx@info{Initialized with driver '\xx@driver'}
  % Avoids multiple initialization.
  \def\dirboxinitializewith#1{
    \xx@warn{Already initialized}
  }
}

%% begin-document hook
\AtBeginDocument{
  % Initialize, if not yet done.
  \ifx\xx@driver\relax
    \dirboxinitialize
  \fi
}

%% Checks the engine if driver is 'ptex'
\ifxx@in@ptex\else
\xx@driver@setup{ptex}{
  \xx@error{The engine does not support driver 'ptex'}
  \@ehc
}
\fi

%% Ascertains that the prerequisite package is loaded.
\xx@driver@setup{cjkvert}{
  \@ifpackageloaded{CJKvert}{}{%else
    \RequirePackage{CJKvert}
  }
}

%---------------------------------------
%% Level-1 Direction-Box Commands
% The commands here are driver-independent.

\@namedef{xx@bc\string\vbox}{\xx@do\vbox}
\@namedef{xx@bc\string\vtop}{\xx@do\vbox}
\@namedef{xx@bc\string\vcenter}{\xx@do\vbox}
\@namedef{xx@bc\string\hbox}{\xx@do\hbox}
\@namedef{xx@bc\string\setbox}{\xx@handle@setbox}
\@namedef{xx@bc\string\global}{\xx@handle@global}

%% \xx@dirbox@error\CS
\def\xx@dirbox@error#1{
  \xx@err@ivbxc#1
  \vbox
}

%%<+> \UseDirBoxTateInYoko{<box-reg>}
\newcommand*\UseDirBoxTateInYoko[1]{
  \vbox{
    \hbox{\rotatebox{-90}{\copy#1}}
    \kern\z@
  }%
}

%%<+> \UseDirBoxYokoInTate{<box-reg>}
\newcommand*\UseDirBoxYokoInTate[1]{
  \vbox{
    \hbox{\rotatebox{90}{\copy#1}}
    \kern-.5\wd#1\relax
    \hrule\@width\z@\@height\z@\@depth.5\wd#1\relax
  }%
}

%%<+> \RawDirBoxTateInYoko[[\global]\setbox<box-reg>=]
%       \BOXCMD<box-spec>{<text>}
% (where \BOXCMD is one of \vbox / \vtop / \vcenter / \hbox
\newcommand\RawDirBoxTateInYoko{
  \let\xx@do@usebox\UseDirBoxTateInYoko
  \xx@rdirbox@gen
}

%%<+> \RawDirBoxTateInYoko[[\global]\setbox<box-reg>=]
%       \BOXCMD<box-spec>{<text>}
% (where \BOXCMD is one of \vbox / \vtop / \vcenter / \hbox
\newcommand\RawDirBoxYokoInTate{
  \let\xx@do@usebox\UseDirBoxYokoInTate
  \xx@rdirbox@gen
}

%% \xx@rdirbox@gen...
\def\xx@rdirbox@gen{
  \let\xx@do\xx@rdirbox@gen@b
  \let\xx@do@assign\@empty
  \xx@with@burst\xx@rdirbox@gen@a
}
  % #1 is either \BOXCMD, \setbox or \global
\def\xx@rdirbox@gen@a#1{
  \@nameuse{xx@bc\meaning#1}\xx@rdirbox@error#1%
  % if #1 is unexpected thing, then \@nameuse results in
  % \relax and \xx@rdirbox@error is invoked.
}
  % #2(= \xx@rdirbox@error) is discarded.
\def\xx@rdirbox@gen@b#1#2#3{
  \let\xx@do@boxcmd#3% = \BOXCMD
  \let\xx@do\xx@rdirbox@gen@c
  \xx@do@after@setbox
  \setbox\xx@tempbox=#1% 'inner' box command
}
  % Invoked after \setbox is done.
\def\xx@rdirbox@gen@c{
  \xx@do@assign% '\setbox...=' or empty
  \xx@do@boxcmd{\xx@do@usebox\xx@tempbox}%
  \DirBoxPostProcess
  \let\DirBoxPostProcess\relax
}

%% \xx@handle@global...
  % Checks if '\setbox' really follows
\def\xx@handle@global#1#2\setbox{ 
  \xx@handle@setbox@a\global\setbox
}

%% \xx@handle@setbox...
\def\xx@handle@setbox#1#2{
  \xx@handle@setbox@a\setbox
}
  % Called as \xx@handle@setbox@a[\global]\setbox...=\BOXCMD
  % #2 is picked up so as to gobble spaces.
\def\xx@handle@setbox@a#1=#2{
  \def\xx@do@assign{#1=}
  \xx@with@burst\xx@rdirbox@gen@a#2%
}

%% \DirBoxPostProcess
\let\DirBoxPostProcess\@empty

%---------------------------------------
%% Font Switching

%%<+> \SwitchFontToYoko
\newcommand*\SwitchFontToYoko{
}

%%<+> \SwitchFontToTate
\newcommand*\SwitchFontToTate{
}

\xx@driver@setup{xetex}{%       %<*xetex>
%% Patch to \defaultfontfeatures

}                               %</xetex>
\xx@driver@setup{cjkvert}{%     %<*cjkvert>
\renewcommand*\SwitchFontToYoko{
  \ifCJK@vertical@
    \CJKhorz
    \aftergroup\CJKvert
  \fi
}
\renewcommand*\SwitchFontToTate{
  \ifCJK@vertical@\else
    \CJKvert
    \aftergroup\CJKhorz
  \fi
}

\newcommand*\setlogicalpagedir[1]{
  \expandafter\let\expandafter\xx@init@cjkdir
   \csname xx@cjkdir@@#1\endcsname
  \ifx\xx@init@cjkdir\relax
    \xx@err@ukdir#1
  \else
    \SetCurrentBoxDir{#1}
  \fi
}
\def\xx@cjkdir@@y{\CJKhorz}
\def\xx@cjkdir@@t{\CJKvert}
\let\xx@init@cjkdir\CJKhorz
\AtBeginDocument{
  \xx@init@cjkdir
}
}                               %</cjkvert>

%---------------------------------------
%% Handling Direction Information

%% \xx@curr@dir
\def\xx@dir@dyna{*}
\def\xx@dir@inv{?}
\let\xx@dir@@y\xx@dir@dyna
\def\xx@dir@@z{z}
\let\xx@curr@dir\xx@dir@dyna

%%<+> \SetCurrentBoxDir{<dir>}
\newcommand*\SetCurrentBoxDir[1]{
  \expandafter\let\expandafter\xx@curr@dir
   \csname xx@dir@@#1\endcsname
  \ifx\xx@curr@dir\relax
    \xx@err@ukdir#1
    \let\xx@curr@dir\xx@dir@inv
  \fi
}

%%<+> \CurrentBoxDir
\newcommand*\CurrentBoxDir{
  \if\xx@curr@dir\xx@dir@dyna y
  \else \xx@curr@dir
  \fi
}

\xx@driver@setup{xetex,cjkvert}{%<*xetex|cjkvert>
%% more directions supported
\def\xx@dir@@t{t}
\def\xx@dir@@d{d}
}                               %</xetex|cjkvert>

\ifxx@in@ptex
\begingroup
  \catcode`|=0 %
\xx@driver@setup{ptex}{%        %<*ptex>
%% more directions supported
% Declares y, t, d to be dynamic.
\let\xx@dir@@y\xx@dir@dyna
\let\xx@dir@@t\xx@dir@dyna
\let\xx@dir@@d\xx@dir@dyna

%%<+> \CurrentBoxDir
\renewcommand*\CurrentBoxDir{
  \if\xx@curr@dir\xx@dir@dyna
    % 'dynamic' directions
    |ifydir y
    |else|iftdir t
    |else|ifddir d
    |else \xx@dir@inv
    |fi|fi|fi
  \else \xx@curr@dir
  \fi
}

}                               %</ptex>
\endgroup
\fi

%---------------------------------------
%% Level-2 Direction-Box Commands

%%<+> \DirBoxYoko
\newcommand*\DirBoxYoko{
  \xx@dirbox@gen y
}

%%<+> \DirBoxTate
\newcommand*\DirBoxTate{
  \xx@dirbox@gen t
}

%%<+> \DirBoxRotR
\newcommand*\DirBoxRotR{
  \xx@dirbox@gen z
}

%%<+> \DirBoxRotL
\newcommand*\DirBoxRotL{
  \xx@dirbox@gen d
}

\def\xx@dirbox@gen#1{
  \expandafter\let\expandafter\xx@dirbox@dirhndl
   \csname xx@dirh@@\CurrentBoxDir @#1\endcsname
  \ifx\xx@dirbox@dirhndl\relax
    \xx@err@usdch\CurrentBoxDir#1
  \else \expandafter\xx@dirbox@dirhndl
  \fi
}

%% Trivial direction handlers.
\let\xx@dirh@@y@y\@empty
\let\xx@dirh@@t@t\@empty
\let\xx@dirh@@z@z\@empty
\let\xx@dirh@@d@d\@empty

%% \xx@local@dirbox
\def\xx@local@dirbox{
  \begingroup
  \let\DirBoxPostProcess\xx@local@dirbox@a
}
\def\xx@local@dirbox@a{
  \endgroup
}

%% \xx@dirh@@y@z
\def\xx@dirh@@y@z{
  \xx@local@dirbox
  \SetCurrentBoxDir{z}
  \RawDirBoxTateInYoko
}

%% \xx@dirh@@z@y
\def\xx@dirh@@z@y{
  \xx@local@dirbox
  \SetCurrentBoxDir{y}
  \RawDirBoxYokoInTate
}

\xx@driver@setup{xetex,cjkvert}{

%% \xx@dirh@@y@t
\def\xx@dirh@@y@t{
  \xx@local@dirbox
  \SetCurrentBoxDir{t}
  \SwitchFontToTate
  \RawDirBoxTateInYoko
}

%% \xx@dirh@@t@y
\def\xx@dirh@@t@y{
  \xx@local@dirbox
  \SetCurrentBoxDir{y}
  \SwitchFontToYoko
  \RawDirBoxYokoInTate
}

}

%--------------------------------------- all done
\endlinechar=13
\endinput
%% EOF
